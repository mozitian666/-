<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Course Selection System</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .dashboard-header {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            padding: var(--spacing-lg) 0;
            margin-bottom: var(--spacing-xl);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title h1 {
            color: var(--primary);
            font-size: var(--font-size-2xl);
            font-weight: 700;
            margin: 0;
        }
        
        .header-subtitle {
            color: var(--text-secondary);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-xs);
        }
        
        .credit-progress {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-xl);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }
        
        .progress-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .progress-text {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: var(--radius-sm);
            transition: width var(--transition-normal);
        }
        
        .course-card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-fast);
            border: 1px solid var(--border-light);
            margin-bottom: var(--spacing-md);
            position: relative;
        }
        
        .course-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .course-card.enrolled {
            border-left: 4px solid var(--success);
        }
        
        .course-card.conflict {
            border-left: 4px solid var(--warning);
        }
        
        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--spacing-md);
        }
        
        .course-info h3 {
            color: var(--text-primary);
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin: 0 0 var(--spacing-xs) 0;
        }
        
        .course-code {
            color: var(--primary);
            font-weight: 500;
            font-size: var(--font-size-sm);
            background: rgba(30, 64, 175, 0.1);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            display: inline-block;
        }
        
        .course-status {
            position: absolute;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
        }
        
        .status-badge {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .status-enrolled {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-available {
            background: rgba(6, 182, 212, 0.1);
            color: var(--info);
        }
        
        .status-conflict {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .course-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }
        
        .course-detail {
            text-align: center;
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        .course-detail-value {
            font-weight: 600;
            color: var(--text-primary);
            font-size: var(--font-size-base);
        }
        
        .course-detail-label {
            color: var(--text-secondary);
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: var(--spacing-xs);
        }
        
        .course-actions {
            display: flex;
            gap: var(--spacing-sm);
            justify-content: flex-end;
        }
        
        .btn-enroll {
            background-color: var(--success);
            color: white;
        }
        
        .btn-enroll:hover {
            background-color: #059669;
        }
        
        .btn-drop {
            background-color: var(--error);
            color: white;
        }
        
        .btn-drop:hover {
            background-color: #dc2626;
        }
        
        .btn-disabled {
            background-color: var(--text-muted);
            color: white;
            cursor: not-allowed;
        }
        
        .schedule-view {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-xl);
        }
        
        .schedule-grid {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }
        
        .schedule-header {
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            padding: var(--spacing-sm);
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
        }
        
        .schedule-time {
            font-weight: 500;
            color: var(--text-secondary);
            text-align: right;
            padding: var(--spacing-sm);
            font-size: var(--font-size-sm);
        }
        
        .schedule-slot {
            min-height: 60px;
            border: 1px solid var(--border-light);
            border-radius: var(--radius-sm);
            padding: var(--spacing-xs);
            position: relative;
        }
        
        .schedule-course {
            background: var(--primary);
            color: white;
            padding: var(--spacing-xs);
            border-radius: var(--radius-sm);
            font-size: var(--font-size-xs);
            text-align: center;
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .course-code-small {
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .course-time-small {
            opacity: 0.9;
            font-size: 0.7em;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }
        
        .empty-state h3 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: var(--spacing-lg);
        }
        
        .tab {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            font-size: var(--font-size-base);
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: color var(--transition-fast);
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--primary);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .course-details {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .course-actions {
                flex-direction: column;
            }
            
            .schedule-grid {
                font-size: var(--font-size-xs);
            }
            
            .schedule-header,
            .schedule-time {
                font-size: var(--font-size-xs);
                padding: var(--spacing-xs);
            }
        }
        
        @media (max-width: 480px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: left;
                padding: var(--spacing-sm) 0;
            }
            
            .tab.active::after {
                bottom: 0;
                height: 1px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="header-content">
                <div class="header-title">
                    <h1>Student Dashboard</h1>
                    <p class="header-subtitle">Browse courses and manage your schedule</p>
                </div>
                <button class="btn btn-secondary" onclick="logout()">
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Credit Progress -->
        <div class="credit-progress">
            <div class="progress-header">
                <h3 class="progress-title">Credit Progress</h3>
                <div class="progress-text">
                    <span id="currentCredits">0</span> / <span id="maxCredits">21</span> credits
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('schedule')">My Schedule</button>
                <button class="tab" onclick="switchTab('available')">Available Courses</button>
            </div>
            
            <!-- Schedule Tab -->
            <div id="scheduleTab" class="tab-content active">
                <div class="schedule-view">
                    <h3>Weekly Schedule</h3>
                    <div class="schedule-grid" id="scheduleGrid">
                        <div class="schedule-header">Time</div>
                        <div class="schedule-header">Monday</div>
                        <div class="schedule-header">Tuesday</div>
                        <div class="schedule-header">Wednesday</div>
                        <div class="schedule-header">Thursday</div>
                        <div class="schedule-header">Friday</div>
                    </div>
                </div>
                
                <div id="myCoursesContainer">
                    <div class="empty-state">
                        <h3>No enrolled courses</h3>
                        <p>Browse available courses to build your schedule</p>
                    </div>
                </div>
            </div>
            
            <!-- Available Courses Tab -->
            <div id="availableTab" class="tab-content">
                <div id="msg" class="alert alert-success hidden"></div>
                <div id="err" class="alert alert-error hidden"></div>
                
                <div id="availableCoursesContainer">
                    <div class="empty-state">
                        <h3>Loading courses...</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/api.js"></script>
    <script>
        let myEnrollments = [];
        let allCourses = [];
        
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'available') {
                loadAllCourses();
            }
        }
        
        function updateCreditProgress() {
            const currentCredits = myEnrollments.reduce((sum, e) => sum + e.course.credits, 0);
            const maxCredits = 21;
            const percentage = (currentCredits / maxCredits) * 100;
            
            document.getElementById('currentCredits').textContent = currentCredits;
            document.getElementById('maxCredits').textContent = maxCredits;
            document.getElementById('progressFill').style.width = Math.min(percentage, 100) + '%';
            
            // Change color if approaching limit
            const progressFill = document.getElementById('progressFill');
            if (currentCredits >= maxCredits) {
                progressFill.style.background = 'linear-gradient(90deg, var(--error) 0%, #dc2626 100%)';
            } else if (currentCredits >= maxCredits * 0.8) {
                progressFill.style.background = 'linear-gradient(90deg, var(--warning) 0%, #f59e0b 100%)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%)';
            }
        }
        
        function generateScheduleGrid() {
            const scheduleGrid = document.getElementById('scheduleGrid');
            const timeSlots = [
                '08:00', '09:00', '10:00', '11:00', '12:00',
                '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'
            ];
            
            const days = ['MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY'];
            
            // Clear existing time slots (keep headers)
            const existingSlots = scheduleGrid.querySelectorAll('.schedule-time, .schedule-slot');
            existingSlots.forEach(slot => slot.remove());
            
            timeSlots.forEach(time => {
                // Add time label
                const timeDiv = document.createElement('div');
                timeDiv.className = 'schedule-time';
                timeDiv.textContent = time;
                scheduleGrid.appendChild(timeDiv);
                
                // Add slots for each day
                days.forEach(day => {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'schedule-slot';
                    slotDiv.dataset.time = time;
                    slotDiv.dataset.day = day;
                    scheduleGrid.appendChild(slotDiv);
                });
            });
        }
        
        function populateSchedule() {
            // Clear existing courses from schedule
            document.querySelectorAll('.schedule-course').forEach(course => course.remove());
            
            myEnrollments.forEach(enrollment => {
                const course = enrollment.course;
                const startHour = parseInt(course.startTime.slice(0, 2));
                const endHour = parseInt(course.endTime.slice(0, 2));
                const day = course.dayOfWeek;
                
                for (let hour = startHour; hour < endHour; hour++) {
                    const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
                    const slot = document.querySelector(`[data-time="${timeSlot}"][data-day="${day}"]`);
                    
                    if (slot) {
                        const courseDiv = document.createElement('div');
                        courseDiv.className = 'schedule-course';
                        courseDiv.innerHTML = `
                            <div class="course-code-small">${course.code}</div>
                            <div class="course-time-small">${course.startTime.slice(0, 5)}-${course.endTime.slice(0, 5)}</div>
                        `;
                        slot.appendChild(courseDiv);
                    }
                }
            });
        }
        
        async function loadMyCourses() {
            try {
                myEnrollments = await fetchJson('/api/student/enrollments');
                displayMyCourses();
                updateCreditProgress();
                populateSchedule();
            } catch (e) {
                console.error('Error loading my courses:', e);
                showError('Failed to load enrolled courses');
            }
        }
        
        function displayMyCourses() {
            const container = document.getElementById('myCoursesContainer');
            
            if (myEnrollments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No enrolled courses</h3>
                        <p>Browse available courses to build your schedule</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = myEnrollments.map(enrollment => {
                const course = enrollment.course;
                return `
                    <div class="course-card enrolled">
                        <div class="course-header">
                            <div class="course-info">
                                <h3>${course.name}</h3>
                                <span class="course-code">${course.code}</span>
                            </div>
                            <div class="course-status">
                                <span class="status-badge status-enrolled">Enrolled</span>
                            </div>
                        </div>
                        
                        <div class="course-details">
                            <div class="course-detail">
                                <div class="course-detail-value">${course.credits}</div>
                                <div class="course-detail-label">Credits</div>
                            </div>
                            <div class="course-detail">
                                <div class="course-detail-value">${course.dayOfWeek}</div>
                                <div class="course-detail-label">Day</div>
                            </div>
                            <div class="course-detail">
                                <div class="course-detail-value">${course.startTime.slice(0, 5)}-${course.endTime.slice(0, 5)}</div>
                                <div class="course-detail-label">Time</div>
                            </div>
                            <div class="course-detail">
                                <div class="course-detail-value">${course.teacher.fullName}</div>
                                <div class="course-detail-label">Teacher</div>
                            </div>
                        </div>
                        
                        <div class="course-actions">
                            <button class="btn btn-sm btn-drop" onclick="dropCourse(${course.id})">
                                <span>Drop Course</span>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        async function loadAllCourses() {
            try {
                allCourses = await fetchJson('/api/student/courses');
                displayAvailableCourses();
            } catch (e) {
                console.error('Error loading available courses:', e);
                showError('Failed to load available courses');
            }
        }
        
        function checkTimeConflict(course) {
            return myEnrollments.some(enrollment => {
                const enrolled = enrollment.course;
                return enrolled.dayOfWeek === course.dayOfWeek &&
                       !(course.endTime <= enrolled.startTime || course.startTime >= enrolled.endTime);
            });
        }
        
        function displayAvailableCourses() {
            const container = document.getElementById('availableCoursesContainer');
            const currentCredits = myEnrollments.reduce((sum, e) => sum + e.course.credits, 0);
            const maxCredits = 21;
            
            const availableCourses = allCourses.filter(course => 
                !myEnrollments.some(e => e.course.id === course.id)
            );
            
            if (availableCourses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No available courses</h3>
                        <p>You are enrolled in all available courses</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = availableCourses.map(course => {
                const isConflict = checkTimeConflict(course);
                const wouldExceedCredits = currentCredits + course.credits > maxCredits;
                const canEnroll = !isConflict && !wouldExceedCredits;
                
                let statusText = 'Available';
                let statusClass = 'status-available';
                
                if (isConflict) {
                    statusText = 'Time Conflict';
                    statusClass = 'status-conflict';
                } else if (wouldExceedCredits) {
                    statusText = 'Credit Limit';
                    statusClass = 'status-conflict';
                }
                
                return `
                    <div class="course-card ${isConflict ? 'conflict' : ''}">
                        <div class="course-header">
                            <div class="course-info">
                                <h3>${course.name}</h3>
                                <span class="course-code">${course.code}</span>
                            </div>
                            <div class="course-status">
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                        </div>
                        
                        <div class="course-details">
                            <div class="course-detail">
                                <div class="course-detail-value">${course.credits}</div>
                                <div class="course-detail-label">Credits</div>
                            </div>
                            <div class="course-detail">
                                <div class="course-detail-value">${course.capacity}</div>
                                <div class="course-detail-label">Capacity</div>
                            </div>
                            <div class="course-detail">
                                <div class="course-detail-value">${course.dayOfWeek}</div>
                                <div class="course-detail-label">Day</div>
                            </div>
                            <div class="course-detail">
                                <div class="course-detail-value">${course.startTime.slice(0, 5)}-${course.endTime.slice(0, 5)}</div>
                                <div class="course-detail-label">Time</div>
                            </div>
                        </div>
                        
                        <div class="course-actions">
                            <button class="btn btn-sm ${canEnroll ? 'btn-enroll' : 'btn-disabled'}" 
                                    onclick="enrollCourse(${course.id})" 
                                    ${!canEnroll ? 'disabled' : ''}>
                                <span>Enroll</span>
                            </button>
                        </div>
                        
                        ${isConflict ? `
                            <div style="margin-top: var(--spacing-sm); color: var(--warning); font-size: var(--font-size-sm);">
                                ⚠️ Time conflict with enrolled course
                            </div>
                        ` : ''}
                        
                        ${wouldExceedCredits ? `
                            <div style="margin-top: var(--spacing-sm); color: var(--error); font-size: var(--font-size-sm);">
                                ⚠️ Would exceed 21 credit limit
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        async function enrollCourse(id) {
            hideMessages();
            
            try {
                await fetchJson('/api/student/enroll/' + id, { method: 'POST' });
                showSuccess('Successfully enrolled in course!');
                await loadMyCourses();
                await loadAllCourses();
            } catch (e) {
                showError(e.message || 'Failed to enroll in course');
            }
        }
        
        async function dropCourse(id) {
            if (!confirm('Are you sure you want to drop this course?')) return;
            
            hideMessages();
            
            try {
                await fetch('/api/student/enroll/' + id, { method: 'DELETE' });
                showSuccess('Successfully dropped course!');
                await loadMyCourses();
                await loadAllCourses();
            } catch (e) {
                showError(e.message || 'Failed to drop course');
            }
        }
        
        function showSuccess(message) {
            const msg = document.getElementById('msg');
            msg.textContent = message;
            msg.classList.remove('hidden');
            setTimeout(() => msg.classList.add('hidden'), 3000);
        }
        
        function showError(message) {
            const err = document.getElementById('err');
            err.textContent = message;
            err.classList.remove('hidden');
            setTimeout(() => err.classList.add('hidden'), 5000);
        }
        
        function hideMessages() {
            document.getElementById('msg').classList.add('hidden');
            document.getElementById('err').classList.add('hidden');
        }
        
        // Initialize schedule grid
        generateScheduleGrid();
        
        // Load initial data
        loadMyCourses();
    </script>
</body>
</html>